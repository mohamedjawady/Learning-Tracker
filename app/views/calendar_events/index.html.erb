<div class="px-4 py-6 sm:px-0">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Learning Calendar</h1>
    <%= link_to "Add Event", new_calendar_event_path, class: "bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium" %>
  </div>

  <!-- Calendar Container -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <div id="calendar" class="min-h-[600px]">
      <!-- Simple Calendar Grid -->
      <div class="grid grid-cols-7 gap-1 mb-4">
        <div class="text-center font-semibold text-gray-700 p-2">Sun</div>
        <div class="text-center font-semibold text-gray-700 p-2">Mon</div>
        <div class="text-center font-semibold text-gray-700 p-2">Tue</div>
        <div class="text-center font-semibold text-gray-700 p-2">Wed</div>
        <div class="text-center font-semibold text-gray-700 p-2">Thu</div>
        <div class="text-center font-semibold text-gray-700 p-2">Fri</div>
        <div class="text-center font-semibold text-gray-700 p-2">Sat</div>
      </div>

      <div class="grid grid-cols-7 gap-1" id="calendar-grid">
        <!-- Calendar days will be generated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Events List -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Upcoming Events -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Upcoming Events</h3>
      </div>
      <div class="p-6">
        <% upcoming_events = @events.select { |e| e.start_date > Time.current }.first(5) %>
        <% if upcoming_events.any? %>
          <div class="space-y-4">
            <% upcoming_events.each do |event| %>
              <div class="flex items-center space-x-4 p-3 rounded-lg border">
                <div class="w-3 h-3 rounded-full <%= event.color_class %>"></div>
                <div class="flex-1">
                  <h4 class="text-sm font-medium text-gray-900"><%= event.title %></h4>
                  <p class="text-xs text-gray-500">
                    <%= event.start_date.strftime("%B %d, %Y at %I:%M %p") %>
                  </p>
                  <% if event.eventable %>
                    <p class="text-xs text-gray-400">
                      Related to: <%= event.eventable.title %>
                    </p>
                  <% end %>
                </div>
                <div class="flex space-x-2">
                  <%= link_to edit_calendar_event_path(event), class: "text-gray-400 hover:text-gray-600" do %>
                    <i class="fas fa-edit text-sm"></i>
                  <% end %>
                  <%= link_to event, 
                      data: { 
                        "turbo-method": "delete",
                        "turbo-confirm": "Are you sure?" 
                      }, 
                      class: "text-red-400 hover:text-red-600" do %>
                    <i class="fas fa-trash text-sm"></i>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-500 text-center py-8">No upcoming events</p>
        <% end %>
      </div>
    </div>

    <!-- Event Types Legend -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Event Types</h3>
      </div>
      <div class="p-6">
        <div class="space-y-3">
          <div class="flex items-center space-x-3">
            <div class="w-4 h-4 rounded-full bg-blue-500"></div>
            <span class="text-sm text-gray-700">Study Session</span>
          </div>
          <div class="flex items-center space-x-3">
            <div class="w-4 h-4 rounded-full bg-red-500"></div>
            <span class="text-sm text-gray-700">Deadline</span>
          </div>
          <div class="flex items-center space-x-3">
            <div class="w-4 h-4 rounded-full bg-yellow-500"></div>
            <span class="text-sm text-gray-700">Reminder</span>
          </div>
          <div class="flex items-center space-x-3">
            <div class="w-4 h-4 rounded-full bg-green-500"></div>
            <span class="text-sm text-gray-700">Todo</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Simple calendar implementation
  const calendarGrid = document.getElementById('calendar-grid');
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const startDate = new Date(firstDay);
  startDate.setDate(startDate.getDate() - firstDay.getDay());
  
  // Events data from server
  const events = <%= raw @events.map { |e| { 
    title: e.title, 
    date: e.start_date.strftime('%Y-%m-%d'), 
    color: e.color_class 
  } }.to_json %>;
  
  for (let i = 0; i < 42; i++) {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + i);
    
    const dayEvents = events.filter(e => e.date === date.toISOString().split('T')[0]);
    
    const dayElement = document.createElement('div');
    dayElement.className = `min-h-[80px] p-1 border border-gray-200 ${
      date.getMonth() === currentMonth ? 'bg-white' : 'bg-gray-50'
    } ${
      date.toDateString() === today.toDateString() ? 'bg-blue-50 border-blue-300' : ''
    }`;
    
    dayElement.innerHTML = `
      <div class="text-sm font-medium text-gray-900 mb-1">${date.getDate()}</div>
      ${dayEvents.map(event => `
        <div class="text-xs p-1 mb-1 rounded truncate ${event.color} text-white">
          ${event.title}
        </div>
      `).join('')}
    `;
    
    calendarGrid.appendChild(dayElement);
  }
});
</script>
