<div class="px-4 py-6 sm:px-0">
  <div class="md:flex md:items-center md:justify-between mb-8">
    <div class="flex-1 min-w-0">
      <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
        <%= @book.title %>
      </h2>
      <% if @book.author.present? %>
        <p class="mt-1 text-sm text-gray-500">by <%= @book.author %></p>
      <% end %>
    </div>
    <div class="mt-4 flex md:mt-0 md:ml-4 space-x-3">
      <% if @book.has_pdf? %>
        <%= link_to viewer_book_path(@book), class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700" do %>
          <i class="fas fa-book-reader mr-2"></i>
          Read PDF
        <% end %>
      <% end %>
      <%= link_to edit_book_path(@book), class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" do %>
        <i class="fas fa-edit mr-2"></i>
        Edit
      <% end %>
      <%= link_to books_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" do %>
        <i class="fas fa-arrow-left mr-2"></i>
        Back to Books
      <% end %>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Book Info -->
    <div class="lg:col-span-2 space-y-6">
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Book Information</h3>
          
          <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
            <div>
              <dt class="text-sm font-medium text-gray-500">Status</dt>
              <dd class="mt-1">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= @book.status == 'completed' ? 'bg-green-100 text-green-800' : @book.status == 'in_progress' ? 'bg-blue-100 text-blue-800' : @book.status == 'paused' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800' %>">
                  <%= @book.status.humanize %>
                </span>
              </dd>
            </div>

            <% if @book.isbn.present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">ISBN</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @book.isbn %></dd>
              </div>
            <% end %>

            <% if @book.start_date.present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Started</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @book.start_date.strftime("%B %d, %Y") %></dd>
              </div>
            <% end %>

            <% if @book.target_completion_date.present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Target Completion</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @book.target_completion_date.strftime("%B %d, %Y") %></dd>
              </div>
            <% end %>

            <% if @book.total_pages.present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Total Pages</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @book.total_pages %></dd>
              </div>
            <% end %>

            <% if @book.current_page.present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Current Page</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @book.current_page %></dd>
              </div>
            <% end %>
          </dl>

          <% if @book.description.present? %>
            <div class="mt-6">
              <dt class="text-sm font-medium text-gray-500">Description</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= simple_format(@book.description) %></dd>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Progress Update -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Update Progress</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Current Page</label>
              <div class="mt-1 flex rounded-md shadow-sm">
                <input type="number" id="current-page" min="0" max="<%= @book.total_pages || 999 %>" value="<%= @book.current_page || 0 %>" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-l-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <button onclick="updateProgress()" class="inline-flex items-center px-3 py-2 border border-l-0 border-gray-300 rounded-r-md bg-gray-50 text-gray-500 sm:text-sm">
                  Update
                </button>
              </div>
              <% if @book.total_pages.present? %>
                <p class="mt-1 text-sm text-gray-500">of <%= @book.total_pages %> pages</p>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Chapters -->
      <% if @chapters.any? %>
        <div class="bg-white shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Chapters</h3>
            
            <div class="space-y-3">
              <% @chapters.each do |chapter| %>
                <div class="flex items-center justify-between p-3 border rounded-lg <%= chapter.completed? ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200' %>">
                  <div class="flex items-center space-x-3">
                    <input type="checkbox" <%= 'checked' if chapter.completed? %> onchange="toggleChapter(<%= chapter.id %>)" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <div>
                      <h4 class="text-sm font-medium text-gray-900"><%= chapter.title %></h4>
                      <% if chapter.description.present? %>
                        <p class="text-sm text-gray-500"><%= truncate(chapter.description, length: 50) %></p>
                      <% end %>
                    </div>
                  </div>
                  <div class="text-sm text-gray-500">
                    Chapter <%= chapter.order_number %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Progress Sidebar -->
    <div class="space-y-6">
      <!-- Reading Progress -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Reading Progress</h3>
          
          <div class="space-y-4">
            <div>
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-500">Pages Progress</span>
                <span class="font-medium text-gray-900"><%= @book.progress_percentage %>%</span>
              </div>
              <div class="mt-2 bg-gray-200 rounded-full h-3">
                <div class="bg-green-600 h-3 rounded-full progress-bar transition-all duration-500 ease-out" style="width: <%= @book.progress_percentage %>%"></div>
              </div>
            </div>

            <% if @chapters.any? %>
              <div>
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-500">Chapters Progress</span>
                  <span class="font-medium text-gray-900"><%= @book.chapters_progress_percentage %>%</span>
                </div>
                <div class="mt-2 bg-gray-200 rounded-full h-3">
                  <div class="bg-blue-600 h-3 rounded-full progress-bar transition-all duration-500 ease-out" style="width: <%= @book.chapters_progress_percentage %>%"></div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Quick Stats</h3>
          
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-sm text-gray-500">Total Chapters</span>
              <span class="text-sm font-medium text-gray-900"><%= @chapters.count %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-500">Completed Chapters</span>
              <span class="text-sm font-medium text-gray-900"><%= @chapters.where(completed: true).count %></span>
            </div>
            <% if @book.total_pages.present? && @book.current_page.present? %>
              <div class="flex justify-between">
                <span class="text-sm text-gray-500">Pages Remaining</span>
                <span class="text-sm font-medium text-gray-900"><%= @book.total_pages - @book.current_page %></span>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Actions</h3>
          
          <div class="space-y-3">
            <%= link_to new_calendar_event_path(eventable_type: 'Book', eventable_id: @book.id), class: "flex items-center p-3 text-sm font-medium text-gray-900 rounded-lg hover:bg-gray-50 group w-full" do %>
              <i class="fas fa-calendar-plus text-indigo-600 mr-3"></i>
              Schedule Reading Session
            <% end %>
            <% if @book.has_pdf? %>
              <%= link_to viewer_book_path(@book), class: "flex items-center p-3 text-sm font-medium text-gray-900 rounded-lg hover:bg-gray-50 group w-full" do %>
                <i class="fas fa-book-reader text-purple-600 mr-3"></i>
                Open PDF Reader
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function updateProgress() {
    const currentPage = document.getElementById('current-page').value;
    
    fetch(`<%= update_progress_book_path(@book) %>`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ current_page: currentPage })
    }).then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show toast notification
        showToast(data.message || `📈 Progress updated to page ${currentPage}!`, 'success');
        // Update progress bars
        document.querySelectorAll('.progress-bar').forEach(bar => {
          if (bar.parentElement.parentElement.querySelector('.text-gray-500').textContent.includes('Pages Progress')) {
            bar.style.width = data.progress + '%';
            bar.parentElement.parentElement.querySelector('.font-medium').textContent = data.progress + '%';
          }
        });
      }
    }).catch(() => {
      showToast('Failed to update progress. Please try again.', 'error');
    });
  }

  function toggleChapter(chapterId) {
    fetch(`/chapters/${chapterId}/complete`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      }
    }).then(response => {
      if (response.ok) {
        showToast('✅ Chapter marked as complete!', 'success');
        setTimeout(() => location.reload(), 1000);
      }
    }).catch(() => {
      showToast('Failed to update chapter. Please try again.', 'error');
    });
  }

  // Global toast function
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('dynamic-toast-container') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `transform transition-all duration-300 ease-in-out opacity-0 translate-y-2 max-w-sm ${getToastClasses(type)}`;
    
    toast.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <i class="${getToastIcon(type)} mr-3 text-lg"></i>
          <span>${message}</span>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Show toast
    setTimeout(() => {
      toast.classList.remove('opacity-0', 'translate-y-2');
      toast.classList.add('opacity-100', 'translate-y-0');
    }, 100);
    
    // Auto hide after 4 seconds
    setTimeout(() => {
      toast.classList.remove('opacity-100', 'translate-y-0');
      toast.classList.add('opacity-0', 'translate-y-2');
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'dynamic-toast-container';
    container.className = 'fixed top-4 right-4 z-50 space-y-2';
    document.body.appendChild(container);
    return container;
  }

  function getToastClasses(type) {
    const baseClasses = 'px-6 py-4 rounded-lg shadow-lg text-white';
    switch(type) {
      case 'success': return `bg-green-500 ${baseClasses}`;
      case 'error': return `bg-red-500 ${baseClasses}`;
      case 'warning': return `bg-yellow-500 ${baseClasses}`;
      case 'info': return `bg-blue-500 ${baseClasses}`;
      default: return `bg-green-500 ${baseClasses}`;
    }
  }

  function getToastIcon(type) {
    switch(type) {
      case 'success': return 'fas fa-check-circle';
      case 'error': return 'fas fa-exclamation-triangle';
      case 'warning': return 'fas fa-exclamation-circle';
      case 'info': return 'fas fa-info-circle';
      default: return 'fas fa-check-circle';
    }
  }
</script>
